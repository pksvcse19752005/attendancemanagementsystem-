<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Management Login</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7;}
        .container { max-width: 920px; margin: 32px auto; background: #fff; padding: 24px; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.08);}
        .loginbox { max-width: 340px; margin: 60px auto; background: #fff; padding: 24px; border-radius: 16px;}
        h2 { text-align: center; margin-bottom: 18px;}
        label { margin-top:12px;}
        input[type="text"], input[type="password"], input[type="date"] { padding:8px; margin:6px 0 10px 0; width:100%; border-radius:6px; border:1px solid #ccc;}
        button { background: #298afb; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-size: 16px; cursor: pointer; margin-bottom: 10px;}
        button:hover { background: #2374d7;}
        th { background: #ffe59b;}
        tr:nth-child(even) { background: #f9f9f9;}
        table { width: 100%; border-collapse: collapse; margin-top: 18px;}
        th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: left;}
        .status-btn { padding: 6px 18px; margin-right: 5px; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;}
        .present-btn { background: #16c79a; }
        .absent-btn { background: #f44336; }
        .permission-btn { background: #007bff; }
        .active { border: 2px solid #222; box-shadow: 0 0 8px #ddd;}
        .hidden { display:none; }
        #dateInput { padding:6px; border-radius:6px; border:1px solid #ccc; margin-right:10px;}
        #saveBtn, #downloadBtn { background:#795548; color:#fff; padding:8px 20px; border-radius:6px; border:none; cursor:pointer; margin:14px 4px;}
        .error { color: #f44336;}
        .success { color: #16c79a;}
    </style>
</head>
<body>

<!-- Login Page -->
<div id="loginbox" class="loginbox">
    <h2>Admin Login</h2>
    <div id="logmsg"></div>
    <label for="username">Username:</label>
    <input type="text" id="username" autocomplete="username">
    <label for="password">Password:</label>
    <input type="password" id="password" autocomplete="current-password">
    <button onclick="login()">Login</button>
    <br>
    <a href="#" onclick="forgotpw();return false;" style="color:#298afb;">Forgot Password?</a>
</div>

<!-- Attendance Dashboard -->
<div id="attendance" class="container hidden">
    <h2>Attendance Management Chart</h2>
    <div id="savemsg"></div>
    <label for="dateInput">Date:</label>
    <input type="date" id="dateInput">
    <button id="saveBtn">Save Attendance</button>
    <button id="downloadBtn">Download Absentees</button>
    <br><br>
    <label><b>Check Attendance Status for a Person:</b></label><br>
    <input type="text" id="checkRegInput" placeholder="Registration Number (e.g. 23KD1A05D3)" style="width:220px;display:inline-block;">
    <input type="date" id="checkDateInput" style="width:160px;display:inline-block;">
    <button onclick="checkStatus()" style="background:#198754;">Check</button>
    <span id="checkResult"></span>
    <table>
        <thead>
            <tr>
                <th>Reg Number</th>
                <th>Name</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="attBody"></tbody>
    </table>
</div>
<script>
const students = [
    ['23KD1A05D3', 'M BHARGAVI'],['23KD1A05D4', 'M PRAVALLIKA'],['23KD1A05D5', 'M VARAPRASAD'],
    ['23KD1A05D6', 'M MEGHANA'],['23KD1A05D7', 'M SWETHA'],['23KD1A05D8', 'M ABHINAV'],
    ['23KD1A05D9', 'M NAVYATHA'],['23KD1A05E0', 'M SINDHUJA'],['23KD1A05E1', 'M PRANATHI'],
    ['23KD1A05E2', 'M HARSHITHA'],['23KD1A05E3', 'M SHARMILA'],['23KD1A05E4', 'M SHAILAJA'],
    ['23KD1A05E5', 'MOHSIN ALI'],['23KD1A05E6', 'M FARHEEN BEGUM'],['23KD1A05E7', 'M VAMSI KRISHNA'],
    ['23KD1A05E8', 'M MADHURI'],['23KD1A05E9', 'M SARAYU SRI'],['23KD1A05F0', 'M YUVA KIRAN'],
    ['23KD1A05F1', 'M JYOTHSNA'],['23KD1A05F2', 'M BENSON'],['23KD1A05F3', 'M BHARAT'],
    ['23KD1A05F4', 'M MANOJ KUMAR'],['23KD1A05F5', 'N DEVI'],['23KD1A05F6', 'N ADHARSH'],
    ['23KD1A05F7', 'N SUBHASH'],['23KD1A05F9', 'N PRAVEEN KUMAR'],['23KD1A05G0', 'N KYATHI'],
    ['23KD1A05G1', 'N PRANATHI'],['23KD1A05G2', 'N HARI CHARAN'],['23KD1A05G3', 'NANADHINI M'],
    ['23KD1A05G4', 'N CHANIKYA'],['23KD1A05G5', 'N MEGHANA'],['23KD1A05G6', 'N SAITEJA'],
    ['23KD1A05G7', 'N DRAKSHAMANI'],['23KD1A05G8', 'N LAVANYA'],['23KD1A05G9', 'N AISHWARYA'],
    ['23KD1A05H0', 'N GEETHA'],['23KD1A05H1', 'P CHIDVILAS'],['23KD1A05H2', 'P KIRAN'],
    ['23KD1A05H3', 'P HARISHANKAR'],['23KD1A05H4', 'P SAIKIRAN'],['23KD1A05H5', 'PVS POORNANANDA'],
    ['23KD1A05H7', 'P GEETHASRI'],['23KD1A05H8', 'P KAVITHA'],['23KD1A05I0', 'P VINEELA'],
    ['23KD1A05I1', 'P SUMANTH'],['23KD1A05I2', 'P GEETHANJALI'],['23KD1A05I3', 'P DEEPIKA'],
    ['23KD1A05I4', 'P AMRUTHA'],['23KD1A05I6', 'P SRIVALLI'],['23KD1A05I7', 'P JAHNAVI'],
    ['23KD1A05I8', 'P SURENDRA REDDY'],['23KD1A05I9', 'P SRAVYA'],['23KD1A05J0', 'P SAHITH'],
    ['23KD1A05J1', 'P BHAVYA SRI'],['23KD1A05J2', 'P MEENAKSHI'],['23KD1A05J3', 'P PRIYANKA'],
    ['23KD1A05J4', 'P CHITTI BABU'],['23KD1A05J5', 'P MYTHRI'],['23KD1A05J6', 'JAHNAVI LATHA'],
    ['23KD1A05J8', 'P VARUDHINI'],['24KD5A0512', 'P REENUKA'],['24KD5A0513', 'P NAGESHWARI'],
    ['24KD5A0514', 'P VINAY'],['24KD5A0515', 'R PREMKUMAR'],['24KD5A0516', 'S SUJATHA'],['24KD5A0517', 'S KUMARRAJA']
];

let attendance = {}; // {date: {reg: status}}

function login() {
    var u = document.getElementById('username').value.trim();
    var p = document.getElementById('password').value.trim();
    fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username:u, password:p})
    }).then(resp=>resp.json()).then(data=>{
        if(data.success){
            document.getElementById('loginbox').classList.add('hidden');
            document.getElementById('attendance').classList.remove('hidden');
            let today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            renderTable(today);
        } else {
            document.getElementById('logmsg').innerHTML = '<div class="error">' + data.error + '</div>';
        }
    });
}

function forgotpw() {
    var u = document.getElementById('username').value.trim() || 'DEPTCSE';
    fetch('/api/forgot_password', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({username:u})
    }).then(resp=>resp.json())
    .then(data=>{
        if(data.success){
            document.getElementById('logmsg').innerHTML = '<div class="success">Reset link sent to admin email.</div>';
        } else {
            document.getElementById('logmsg').innerHTML = `<div class="error">${data.error}</div>`;
        }
    });
}

function renderTable(date) {
    let tbody = document.getElementById('attBody');
    tbody.innerHTML = '';
    students.forEach(([reg,name]) => {
        let stat = (attendance[date] && attendance[date][reg]) || "Absent";
        let tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${reg}</td>
            <td>${name}</td>
            <td>
                <button class="status-btn present-btn${stat=='Present'?' active':''}" onclick="setStatus('${reg}','Present',this)">Present</button>
                <button class="status-btn absent-btn${stat=='Absent'?' active':''}" onclick="setStatus('${reg}','Absent',this)">Absent</button>
                <button class="status-btn permission-btn${stat=='Permission'?' active':''}" onclick="setStatus('${reg}','Permission',this)">Permission</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function setStatus(reg, status, btn) {
    let date = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
    if (!attendance[date]) attendance[date] = {};
    attendance[date][reg] = status;
    let td = btn.parentNode;
    [...td.children].forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

document.getElementById('dateInput').onchange = function() {
    renderTable(this.value);
};

document.getElementById('saveBtn').onclick = function() {
    let date = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
    let attData = {};
    students.forEach(([reg,name]) => {
        attData[reg] = {name: name, status: (attendance[date] && attendance[date][reg]) || "Absent"};
    });
    fetch('/api/save', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({date: date, attendance: attData})
    }).then(resp=>resp.json()).then(data=>{
        if(data.success){
            document.getElementById('savemsg').innerHTML = '<div class="success">Attendance saved for '+date+'</div>';
            setTimeout(()=>{ document.getElementById('savemsg').innerHTML=''; }, 3000);
        }
    });
};

document.getElementById('downloadBtn').onclick = function() {
    let date = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
    let attData = {};
    students.forEach(([reg,name]) => {
        attData[reg] = {name: name, status: (attendance[date] && attendance[date][reg]) || "Absent"};
    });
    fetch('/api/save', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({date: date, attendance: attData})
    }).then(resp=>resp.json()).then(data=>{
        if(data.success){
            window.open('/api/export_absentees/' + date, '_blank');
        }
    });
};

function checkStatus() {
    let reg = document.getElementById('checkRegInput').value.trim().toUpperCase();
    let date = document.getElementById('checkDateInput').value;
    if(!reg || !date){
        document.getElementById('checkResult').innerHTML = '<span class="error">Enter reg. number and date</span>';
        return;
    }
    fetch('/api/check?regno='+reg+'&date='+date)
    .then(resp=>resp.json())
    .then(data=>{
        document.getElementById('checkResult').innerText = `${reg} was marked as '${data.status}' on ${date}`;
    });
}

window.onload = function() {
    document.getElementById('attendance').classList.add('hidden');
    document.getElementById('loginbox').classList.remove('hidden');
    let today = new Date().toISOString().split('T')[0];
    document.getElementById('checkDateInput').value = today;
};
</script>
</body>
</html>
